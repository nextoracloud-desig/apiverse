generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                @id @default(cuid())
  name                   String?
  email                  String?               @unique
  emailVerified          DateTime?
  image                  String?
  password               String?
  role                   String                @default("user")
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  stripeCustomerId       String?               @unique
  stripeSubscriptionId   String?               @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  plan                   String                @default("free")
  onboarded              Boolean               @default(false)
  passwordHash           String?
  accounts               Account[]
  feedback               ApiFeedback[]
  apiViews               ApiView[]
  comments               Comment[]
  likes                  Like[]
  notifications          Notification[]
  portalKeys             PortalKey[]
  posts                  Post[]
  projects               Project[]
  recommendationEvents   RecommendationEvent[]
  savedApis              SavedApi[]
  sessions               Session[]
  apiKeys                UserApiKey[]
  workspaces             Workspace[]
}

model Project {
  id          String      @id @default(cuid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  portalKeys  PortalKey[]
  owner       User        @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model PortalKey {
  id           String           @id @default(cuid())
  userId       String
  projectId    String?
  apiId        String
  key          String           @unique
  status       String           @default("active")
  lastUsedAt   DateTime?
  usageCount   Int              @default(0)
  createdAt    DateTime         @default(now())
  usageMetrics ApiUsageMetric[]
  api          Api              @relation(fields: [apiId], references: [id], onDelete: Cascade)
  project      Project?         @relation(fields: [projectId], references: [id])
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ApiUsageMetric {
  id               String    @id @default(cuid())
  portalKeyId      String
  period           String
  source           String    @default("portal-key")
  requestCount     Int       @default(0)
  errorCount       Int       @default(0)
  avgLatencyMs     Int       @default(0)
  estimatedCostUsd Float     @default(0.0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  portalKey        PortalKey @relation(fields: [portalKeyId], references: [id], onDelete: Cascade)

  @@unique([portalKeyId, period])
}

model RecommendationEvent {
  id              String   @id @default(cuid())
  userId          String?
  description     String
  primaryCategory String
  region          String?
  createdAt       DateTime @default(now())
  user            User?    @relation(fields: [userId], references: [id])
}

model ApiAlt {
  id        String   @id @default(cuid())
  apiId     String
  altApiId  String
  reason    String?
  createdAt DateTime @default(now())
  altApi    Api      @relation("AltApi", fields: [altApiId], references: [id], onDelete: Cascade)
  api       Api      @relation("MainApi", fields: [apiId], references: [id], onDelete: Cascade)

  @@unique([apiId, altApiId])
}

model ApiLockInScore {
  id               String   @id @default(cuid())
  apiId            String   @unique
  portabilityScore Int      @default(50)
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  api              Api      @relation(fields: [apiId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model UserApiKey {
  id        String   @id @default(cuid())
  userId    String
  apiId     String
  key       String   @unique
  name      String?  @default("My API Key")
  limit     Int      @default(1000)
  usage     Int      @default(0)
  status    String   @default("active")
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SavedApi {
  id        String   @id @default(cuid())
  userId    String
  apiId     String
  createdAt DateTime @default(now())
  api       Api      @relation(fields: [apiId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, apiId])
}

model Api {
  id                        String          @id @default(cuid())
  slug                      String          @unique
  name                      String
  shortDescription          String
  longDescription           String
  category                  String
  subCategory               String?
  tags                      String
  pricingType               String
  regionSupport             String?
  dxScore                   Int             @default(0)
  popularityScore           Int             @default(0)
  logoUrl                   String?
  logoSymbol                String?
  docsUrl                   String
  providerUrl               String
  providerName              String
  confidenceScore           Int             @default(0)
  rating                    Float           @default(0)
  reviewCount               Int             @default(0)
  uptimeSla                 String?
  sampleEndpointUrl         String?
  playgroundExampleResponse String?
  featured                  Boolean         @default(false)
  source                    String          @default("manual")
  status                    String          @default("active")
  affiliateUrl              String?
  referralNote              String?
  createdAt                 DateTime        @default(now())
  lastChecked               DateTime?
  latency                   Int             @default(0)
  verified                  Boolean         @default(false)
  updatedAt                 DateTime        @updatedAt
  usedAsAlternativeFor      ApiAlt[]        @relation("AltApi")
  alternatives              ApiAlt[]        @relation("MainApi")
  feedback                  ApiFeedback[]
  lockInScore               ApiLockInScore?
  portalKeys                PortalKey[]
  savedBy                   SavedApi[]

  @@index([category])
  @@index([pricingType])
  @@index([status])
  @@index([featured])
}

model ApiFeedback {
  id        String   @id @default(cuid())
  apiId     String
  userId    String
  rating    Int      @default(0)
  badge     String?
  comment   String?
  createdAt DateTime @default(now())
  api       Api      @relation(fields: [apiId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, apiId])
}

model ApiImportJob {
  id        String   @id @default(cuid())
  source    String
  status    String
  statsJson String
  createdAt DateTime @default(now())
}

model ApiView {
  id        String   @id @default(cuid())
  apiId     String
  userId    String?
  source    String?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model Post {
  id        String    @id @default(cuid())
  title     String
  content   String
  authorId  String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  comments  Comment[]
  likes     Like[]
  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  postId    String
  authorId  String
  createdAt DateTime @default(now())
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

model Like {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ApiProvider {
  id          String     @id @default(cuid())
  name        String
  baseUrl     String
  authType    String     @default("none")
  authConfig  String?
  docsUrl     String?
  description String?
  category    String?
  source      String     @default("manual")
  approved    Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  apiKeys     ApiKey[]
  usageLogs   UsageLog[]
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  ownerId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  apiKeys   ApiKey[]
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
}

model ApiKey {
  id           String       @id @default(cuid())
  name         String
  hashedSecret String
  limit        Int          @default(1000)
  usage        Int          @default(0)
  revoked      Boolean      @default(false)
  scopes       String?
  lastUsedAt   DateTime?
  workspaceId  String
  providerId   String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  provider     ApiProvider? @relation(fields: [providerId], references: [id])
  workspace    Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  usageLogs    UsageLog[]
}

model UsageLog {
  id         String       @id @default(cuid())
  method     String
  path       String
  statusCode Int
  latency    Int
  cost       Float        @default(0)
  apiKeyId   String?
  providerId String?
  timestamp  DateTime     @default(now())
  apiKey     ApiKey?      @relation(fields: [apiKeyId], references: [id])
  provider   ApiProvider? @relation(fields: [providerId], references: [id])
}
